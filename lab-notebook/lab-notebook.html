<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lab automation notebook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="lab-notebook_files/libs/clipboard/clipboard.min.js"></script>
<script src="lab-notebook_files/libs/quarto-html/quarto.js"></script>
<script src="lab-notebook_files/libs/quarto-html/popper.min.js"></script>
<script src="lab-notebook_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="lab-notebook_files/libs/quarto-html/anchor.min.js"></script>
<link href="lab-notebook_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="lab-notebook_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="lab-notebook_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="lab-notebook_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="lab-notebook_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lab automation notebook</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Lennart Justen<br>
Created: 2024-04-15</p>
<section id="serial-dilution-workflow" class="level2">
<h2 class="anchored" data-anchor-id="serial-dilution-workflow">2024-04-15: Serial dilution workflow</h2>
<p>Today I spent around three hours in the Media Lab space and managed to set up a workflow for performing serial dilutions on the Opentron. I chose to work on serial dilutions today because their pretty straightforward from an automation perspective and seem like a good “easy” candidate for an LLM to attempt. In this entry, I’ll walk through the PyLabRobot implementation and comment on a few takeaways after today’s session.</p>
<section id="serial-dilution-background" class="level3">
<h3 class="anchored" data-anchor-id="serial-dilution-background">Serial dilution background</h3>
<p>Serial dilutions are a fundamental technique used to systematically dilute a concentrated solution by creating a series of successive dilutions, each being a fixed ratio of the previous one. The two most common dilution factors are ten-fold (1:10) and two-fold (1:2). In a ten-fold serial dilution, each subsequent dilution is 10 times less concentrated than the previous one, while in a two-fold serial dilution, each subsequent dilution is 2 times less concentrated.</p>
<p>Ten-fold serial dilutions are typically used when a large range of concentrations needs to be covered, such as in bacterial enumeration or viral titer determination. Two-fold serial dilutions are often used when a more precise concentration range is required, such as in ELISA assays for antibody titer determination.</p>
<p>I won’t say much more here about serial dilutions because there are many great resources like <a href="https://www.integra-biosciences.com/united-states/en/blog/article/how-do-serial-dilutions-including-calculations">this one</a> where you can learn more.</p>
</section>
<section id="lession-1-claude-understands-serial-dilutions" class="level3">
<h3 class="anchored" data-anchor-id="lession-1-claude-understands-serial-dilutions">Lession 1: Claude understands serial dilutions</h3>
<p>Very early in the process, I asked Claude (Opus) to explain how the serial dilution would work given my lab setup. Claude helpfully outlined the steps I would need to take, and I based my implementation on the instructions. Later, when trying to recreate the behavior, Claude would sometimes accidentally provide me instructions for a 4-step dultion instead of a 5-step dilution (see example below), and once suggested adding more volume to a single well than was actually possible.</p>
<p><strong>LJ</strong></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>I want perform a simple 5-step 10-fold serial dilution on an Opentrons liquid handling robot. This example is more to help me understand the math and logic behind the process as opposed to achieving some experimental goal. </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>Given the following resources, walk me through the steps for performing the serial dilution.</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ss"> 1. </span>A 360 uL 96-well plate</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ss"> 2. </span>A beaker of water (dilutent)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ss"> 3. </span>A beaker of water + food coloring (my concentrated solution)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Claude</strong></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Great! Let's walk through the steps for performing a simple 5-step 10-fold serial dilution using an Opentrons liquid handling robot. We'll use water as the diluent and water with food coloring as the concentrated solution.</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>Resources:</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>A 360 µL 96-well plate</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>A beaker of water (diluent)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>A beaker of water + food coloring (concentrated solution)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>Steps:</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Begin by adding 180 µL of water (diluent) to wells A2, A3, A4, and A5 of the 96-well plate using the Opentrons robot.</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Add 200 µL of the water + food coloring solution (concentrated solution) to well A1 of the 96-well plate.</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Transfer 20 µL of the solution from well A1 to well A2 using the Opentrons robot. Mix the contents of well A2 by pipetting up and down a few times. This step creates a 1:10 dilution (10^-1) of the original solution.</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Transfer 20 µL of the diluted solution from well A2 to well A3. Mix the contents of well A3 by pipetting up and down a few times. This step creates a 1:100 dilution (10^-2) of the original solution.</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Transfer 20 µL of the diluted solution from well A3 to well A4. Mix the contents of well A4 by pipetting up and down a few times. This step creates a 1:1,000 dilution (10^-3) of the original solution.</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>Transfer 20 µL of the diluted solution from well A4 to well A5. Mix the contents of well A5 by pipetting up and down a few times. This step creates a 1:10,000 dilution (10^-4) of the original solution.</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>At the end of this process, you will have the following dilutions in your 96-well plate:</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Well A1: Original concentrated solution</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Well A2: 1:10 dilution (10^-1)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Well A3: 1:100 dilution (10^-2)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Well A4: 1:1,000 dilution (10^-3)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Well A5: 1:10,000 dilution (10^-4)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>The math behind each dilution step is as follows:</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Step 3: (20 µL of solution A1 + 180 µL of diluent) / 200 µL total volume = 1:10 dilution</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Step 4: (20 µL of solution A2 + 180 µL of diluent) / 200 µL total volume = 1:100 dilution</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Step 5: (20 µL of solution A3 + 180 µL of diluent) / 200 µL total volume = 1:1,000 dilution</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="ss">* </span>Step 6: (20 µL of solution A4 + 180 µL of diluent) / 200 µL total volume = 1:10,000 dilution</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>The Opentrons robot can be programmed to perform these steps accurately and consistently, making the serial dilution process more efficient and reproducible.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Thanks Claude!</p>
</section>
<section id="implementing-the-serial-dilution-on-pylabrobot" class="level3">
<h3 class="anchored" data-anchor-id="implementing-the-serial-dilution-on-pylabrobot">Implementing the serial dilution on PyLabRobot</h3>
<p>For this part, I didn’t use any LLMs outside of a few basic syntax questions where the LLM replaced stack overflow. Doing this “manually” was helpful to get more comfortable with PyLabRobot and also go end-to-end on a protocol implementation. I think that was actually the most important part, because I learned how protocol development occurs, and what it takes to “debug” your protocol in real-time. Using Jupyter notebooks is incredibly powerful for this because you can perform single commands and verify that each piece of your protocol works before moving onto the next part. Let’s look at the implementation and then I’ll discuss a few takeaways.</p>
<div id="initial_id" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-04-16T01:46:43.914618Z&quot;,&quot;start_time&quot;:&quot;2024-04-16T01:46:43.192942Z&quot;}" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pylabrobot.liquid_handling <span class="im">import</span> LiquidHandler</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pylabrobot.liquid_handling.backends <span class="im">import</span> OpentronsBackend</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pylabrobot.visualizer.visualizer <span class="im">import</span> Visualizer</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pylabrobot.resources <span class="im">import</span> OTDeck, Coordinate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4a50381fc6e2e345" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-04-15T22:16:35.741361Z&quot;,&quot;start_time&quot;:&quot;2024-04-15T22:16:23.537215Z&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic setup</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>backend <span class="op">=</span> OpentronsBackend(host<span class="op">=</span><span class="st">"169.254.184.185"</span>, port<span class="op">=</span><span class="dv">31950</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>lh <span class="op">=</span> LiquidHandler(backend<span class="op">=</span>backend, deck<span class="op">=</span>OTDeck())</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> lh.setup() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fec59408a5aebb5c" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-04-15T22:16:36.897169Z&quot;,&quot;start_time&quot;:&quot;2024-04-15T22:16:35.742729Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define tips and well plate resources </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pylabrobot.resources.opentrons <span class="im">import</span> <span class="op">*</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>tips300 <span class="op">=</span> opentrons_96_tiprack_300ul(<span class="st">"tip_rack_300"</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>lh.deck.assign_child_at_slot(tips300, slot<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>tips20 <span class="op">=</span> opentrons_96_tiprack_20ul(<span class="st">"tip_rack_20"</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>lh.deck.assign_child_at_slot(tips20, slot<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>well_plate <span class="op">=</span> corning_96_wellplate_360ul_flat(<span class="st">"96_wellplate_360ul_flat"</span>)  <span class="co"># well volume is 400 uL MAX. Probably use 200-300 uL. </span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>lh.deck.assign_child_at_slot(well_plate, slot<span class="op">=</span><span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s define two custom resource for our dye solution and dilutent beakers.</p>
<div id="95cb583492b07b1a" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-04-15T22:16:37.169843Z&quot;,&quot;start_time&quot;:&quot;2024-04-15T22:16:36.902941Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pylabrobot.resources <span class="im">import</span> Container, Coordinate</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define custom beaker resource with dilutent</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>dilutent_deck_slot <span class="op">=</span> Container(name<span class="op">=</span><span class="st">"dilutent_deck_parent"</span>, size_x<span class="op">=</span><span class="dv">127</span>,size_y<span class="op">=</span><span class="dv">86</span>,size_z<span class="op">=</span><span class="dv">0</span>)  <span class="co"># Dimensions of a single slot on the Opentrons deck</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>dilutent_beaker <span class="op">=</span> Container(name<span class="op">=</span><span class="st">'dilutent_beaker'</span>, size_x<span class="op">=</span><span class="dv">40</span>,size_y<span class="op">=</span><span class="dv">40</span>,size_z<span class="op">=</span><span class="dv">10</span>)  <span class="co"># Dimensions of the beaker represented as a 3-dimensional box</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>dilutent_deck_slot.assign_child_resource(dilutent_beaker, Coordinate(x<span class="op">=</span><span class="fl">43.5</span>, y<span class="op">=</span><span class="dv">23</span>, z<span class="op">=</span><span class="dv">0</span>))  <span class="co"># Coordinates of the beaker with respect to the beaker_parent coordinate system</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>lh.deck.assign_child_at_slot(dilutent_deck_slot, slot<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Define custom beaker resource with dye solution</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>dye_deck_slot <span class="op">=</span> Container(name<span class="op">=</span><span class="st">"dye_deck_parent"</span>, size_x<span class="op">=</span><span class="dv">127</span>,size_y<span class="op">=</span><span class="dv">86</span>,size_z<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>dye_beaker <span class="op">=</span> Container(name<span class="op">=</span><span class="st">'dye_beaker'</span>, size_x<span class="op">=</span><span class="dv">25</span>,size_y<span class="op">=</span><span class="dv">24</span>,size_z<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>dye_deck_slot.assign_child_resource(dye_beaker, Coordinate(x<span class="op">=</span><span class="fl">43.5</span>, y<span class="op">=</span><span class="dv">23</span>, z<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>lh.deck.assign_child_at_slot(dye_deck_slot, slot<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="882fc22d4d46cabd" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-04-15T22:16:37.178276Z&quot;,&quot;start_time&quot;:&quot;2024-04-15T22:16:37.174100Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>lh.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Deck: 624.3mm x 565.2mm

+-----------------+-----------------+-----------------+
|                 |                 |                 |
| 10: tip_rack... | 11: Empty       | 12: trash_co... |
|                 |                 |                 |
+-----------------+-----------------+-----------------+
|                 |                 |                 |
|  7: 96_wellp... |  8: tip_rack... |  9: Empty       |
|                 |                 |                 |
+-----------------+-----------------+-----------------+
|                 |                 |                 |
|  4: Empty       |  5: Empty       |  6: Empty       |
|                 |                 |                 |
+-----------------+-----------------+-----------------+
|                 |                 |                 |
|  1: dilutent... |  2: bacteria... |  3: Empty       |
|                 |                 |                 |
+-----------------+-----------------+-----------------+</code></pre>
</div>
</div>
<p>Next, let’s label wells with their respective dilution factors for clarity.</p>
<div id="1a35e5fbe0daf200" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-04-15T22:16:40.179589Z&quot;,&quot;start_time&quot;:&quot;2024-04-15T22:16:40.160097Z&quot;}" data-execution_count="16">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>initial <span class="op">=</span> well_plate[<span class="st">'A1'</span>]  <span class="co"># initial concentration</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>dilution1 <span class="op">=</span> well_plate[<span class="st">'A2'</span>]  <span class="co"># 1:10 dilution</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>dilution2 <span class="op">=</span> well_plate[<span class="st">'A3'</span>]  <span class="co"># 1:100 dilution</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>dilution3 <span class="op">=</span> well_plate[<span class="st">'A4'</span>]  <span class="co"># 1:1000 dilution</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>dilution4 <span class="op">=</span> well_plate[<span class="st">'A5'</span>]  <span class="co"># 1:10000 dilution</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>dilution5 <span class="op">=</span> well_plate[<span class="st">'A6'</span>]  <span class="co"># 1:100000 dilution</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>dilution_wells <span class="op">=</span> [dilution1, dilution2, dilution3, dilution4, dilution5]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s transfer 200 uL of the original dye-containing solution into the <code>initial</code> well.</p>
<div id="b0cc71ef6d82fe9b" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-04-15T22:17:17.774931Z&quot;,&quot;start_time&quot;:&quot;2024-04-15T22:16:46.040790Z&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> lh.pick_up_tips(tips300[<span class="ss">f'A1'</span>], offsets<span class="op">=</span>[Coordinate(y<span class="op">=</span><span class="fl">0.18</span>, z<span class="op">=-</span><span class="dv">6</span>)]) <span class="co"># pick up a new tip</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> lh.aspirate(dye_beaker,<span class="dv">200</span>, offsets<span class="op">=</span>[Coordinate(z<span class="op">=</span><span class="dv">8</span>)]) <span class="co"># grab dye solution from beaker resource</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> lh.dispense(initial, vols<span class="op">=</span><span class="dv">200</span>, offsets<span class="op">=</span>[Coordinate(y<span class="op">=</span><span class="fl">0.2</span>)])</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> lh.discard_tips()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we’ll transfer 180 uL of dilutent into each of the dilution wells. We will reuse the pipette tip since we’re just transfering water and discard it at the end.</p>
<div id="ffbbe663a3a51b59" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-04-15T22:18:16.257822Z&quot;,&quot;start_time&quot;:&quot;2024-04-15T22:17:17.773520Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> lh.pick_up_tips(tips300[<span class="ss">f'A2'</span>], offsets<span class="op">=</span>[Coordinate(y<span class="op">=</span><span class="fl">0.18</span>, z<span class="op">=-</span><span class="dv">6</span>)]) <span class="co"># pick up a new tip</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, well <span class="kw">in</span> <span class="bu">enumerate</span>(dilution_wells):</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> lh.aspirate(dilutent_beaker,<span class="dv">180</span>, offsets<span class="op">=</span>[Coordinate(z<span class="op">=</span><span class="dv">20</span>)]) <span class="co"># grab dilutent from beaker resource</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> lh.dispense(well, vols<span class="op">=</span><span class="dv">180</span>, offsets<span class="op">=</span>[Coordinate(y<span class="op">=</span><span class="fl">0.2</span>)])</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> lh.discard_tips()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we’ll transfer 20 uL from the dye solution beaker into the <code>dilution1</code> well, creating our 1:10 dilution. We’ll then take 20 uL from <code>dilution1</code> and transfer it to <code>dilution2</code> well and so on, until we’ve performed all of our dilutions.</p>
<div id="1c024bb3360b294c" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2024-04-15T22:19:29.803578Z&quot;,&quot;start_time&quot;:&quot;2024-04-15T22:18:16.256329Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> lh.pick_up_tips(tips20[<span class="ss">f'A1'</span>], offsets<span class="op">=</span>[Coordinate(z<span class="op">=-</span><span class="dv">6</span>)]) <span class="co"># pick up a new tip</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> lh.aspirate(dye_beaker,<span class="dv">20</span>, offsets<span class="op">=</span>[Coordinate(z<span class="op">=</span><span class="dv">8</span>)])  <span class="co"># get liquid from bacteria beaker</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> lh.dispense(dilution1,<span class="dv">20</span>, offsets<span class="op">=</span>[Coordinate(z<span class="op">=</span><span class="dv">2</span>)])  <span class="co"># aspirate to make 1:10 dilution</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(dilution_wells) <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    source_well <span class="op">=</span> dilution_wells[i]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    destination_well <span class="op">=</span> dilution_wells[i<span class="op">+</span><span class="dv">1</span>]</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> lh.aspirate(source_well, <span class="dv">20</span>, offsets<span class="op">=</span>[Coordinate(z<span class="op">=-</span><span class="fl">6.5</span>)])</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> lh.dispense(destination_well, <span class="dv">20</span>, offsets<span class="op">=</span>[Coordinate(z<span class="op">=</span><span class="dv">2</span>)])</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> lh.discard_tips()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Voilà. I tested the protocol and it (mostly) works (video available <a href="https://drive.google.com/file/d/1tfTrZ-EDtZxzYby-h9OeZ4C_8xqy8Qm7/view?usp=sharing">here</a>). The main issue I saw on the current implementation is that when dispensing with the 20 uL pipette step, a drop tends to form at the bottom of the pipette that likes to hang on to the tip… unfortunately that drop represents about half the volume inside the pipette. This is probably an issue addressed somewhere, so I’ll need to read up on that. On a related not, I didn’t really do any mixing of the dilutions. I could have aspirated/dispensed a few times with the tip in the well. This would have both mixed the solution and ensured the drop made it into the well.</p>
<p>Other improvements to consider: * Use a <a href="https://parheliabio.com/product/opentrons-multi-channel-electronic-pipette-p300/">multi-channel adapter</a> for the OT to save time when transferring dilutent (Thanks for making me aware of this, Alex K!) * If I was doing this for real, I should have discarded tips between each dilution step to avoid tracking in liquid from a different well. In avoided this to save time and tips.</p>
</section>
<section id="lesson-2-iterative-protocol-development-is-your-friend" class="level3">
<h3 class="anchored" data-anchor-id="lesson-2-iterative-protocol-development-is-your-friend">Lesson 2: Iterative protocol development is your friend</h3>
<p>When I was initially thinking about this project, I was somewhat naive in believing that LLMs would be able to 1-shot large portions of protocols or entire protocols. That seems hard.</p>
<p>Developing the protocol was an iterative process. Are the custom resources in the right sopt on the deck? Is the tip going far enough into the beaker to actually pick up liquid? How deep does the 20 uL tip need to go into the 96-well-plate to actually aspirate liquid? All of these questions that pop up are difficult to know, even when you have pretty good knowledge of the deck setup. Some trial and error is inherent in the process. The fact that you can execute single commands in Jupyter notebook is really useful as it let’s you iterate over a step.</p>
<p>The scenario below is hopefully illustrative of how a lot of the development happened.</p>
<blockquote class="blockquote">
<p>Alright… I need to get the robot to aspirate liquid from this beaker. I’ll define it on the deck and then actually put water in the beaker and put it on the deck. Now let’s try the aspirate step with a z coordinate z=40. Oops. To high. Didn’t get any liquid but the API thinks I have liquid in the top. Okay, send a command to dispense the ghost liquid. Alright, how about z=20… okay, that worked. Dispense. Okay pick up a new tip. Shoot, I asked it to pick up a tip from an empty tip slot. Okay, put pack the ghost tip and move out of the way so I can put a tip in there… So on and so forth.</p>
</blockquote>
<p>In this kind of workflow where code meets the real world, iteration is your friend and it currently seems unrealistic to me for LLMs to do any kind of one-shot-and-run protocol development here. That said, if you can figure out and communicate to LLMs where their capabilities <em>will</em> be helpful, then I’m sure they can still be great automation assistant. For example, they could come up with the main skeleton script, helpfully divided into test-able parts and flag places where testing needs to be done. Today was helpful to get me thinking more about how LLMs can fit into the lab automation workflow grounded in a more realistic understanding of protocol development.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>